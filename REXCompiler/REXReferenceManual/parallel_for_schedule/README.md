# 1. Introduction

### 1.1 Input
- `schedule.c`: `omp parallel for` directive with different `schedule` clauses
- `Makefile`: Use Clang/GCC to compile the output files

### 1.2 Dependencies from REX compiler
- `rex_kmp.h`: REX header for using LLVM OpenMP runtime

### 1.3 Output
- `rose_schedule.c`: main file with kernel launching driver
- `rex_lib_schedule.c`: the file having outlined functions


# 2. Build

So far, the output files work on both Clang and GCC. The `.cubin` file must be generated by nvcc.
In `Makefile`, by default Clang is used for compilation. GCC requires the additional parameter `-Wl,--no-as-needed -lomp`.
Without this specific parameter, GCC won't link `libomp.so` to the program because it doesn't directly use any functions from that library.
However, without `libomp.so`, the program will throw an error:
```bash
terminate called after throwing an instance of 'std::system_error'
  what():  Unknown error -1
Aborted (core dumped)
```
Therefore, we have to force to link the library. Clang doesn't have this issue. If using nvcc to compile the main file, it also requires this parameter.
Please also notice that in the `Makefile`, the `$CUDA_ARCH` variable has to be set properly. For example, on Fornax, it's `sm_37`. On Carina, it's `sm_70`.

To compile:
```bash
make
```


# 3. Run

```bash
./schedule.out
```

The program will print ten times of string `Test.`. Running `nvprof` shows that the kernel runs on GPU.
The code has been tested on Fornax with NVIDIA Tesla K80, CUDA toolkit 10.1, and Clang/LLVM 10.x.

Clang/LLVM 11+ starts to include the monotonicity into scheduling policy while Clang/LLVM 10.x doesn't. For example, the enum corresponding to dynamic policy is 35 in Clang/LLVM 10.x, but it's 1073741859 in Clang/LLVM 11+ because the new enum is the original dynamic policy enum 35 + the monotonicityenum 2<<30. 
This change is due to the OpenMP 5.0 specification, which specifies the default monotonicity. Prior to OpenMP 5.0, the monotonicity can be ignored if no schedule modifier is provided.

# 4. On-going work


# 5. Issues


